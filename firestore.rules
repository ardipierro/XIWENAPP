rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Check if user is admin
    function isAdmin() {
      return request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Check if user is teacher
    function isTeacher() {
      return request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // ============================================
    // PAYMENT SYSTEM COLLECTIONS
    // ============================================

    // Student enrollments - students/guardians can read their own, admins can write
    match /student_enrollments/{enrollmentId} {
      allow read: if isAuthenticated() &&
        (resource.data.studentId == request.auth.uid ||
         resource.data.guardianId == request.auth.uid ||
         isAdmin());
      allow write: if isAdmin();
    }

    // Monthly fees - students can read their own, only Cloud Functions can write
    match /monthly_fees/{feeId} {
      allow read: if isAuthenticated() &&
        (resource.data.studentId == request.auth.uid || isAdmin());
      allow write: if false;  // Only Cloud Functions can write
    }

    // Scholarships - students can read their own, admins can write
    match /scholarships/{scholarshipId} {
      allow read: if isAuthenticated() &&
        (resource.data.studentId == request.auth.uid || isAdmin());
      allow write: if isAdmin();
    }

    // Family groups - guardians can read their own, admins can write
    match /family_groups/{groupId} {
      allow read: if isAuthenticated() &&
        (resource.data.guardianId == request.auth.uid || isAdmin());
      allow write: if isAdmin();
    }

    // Payments - users can read their own, only Cloud Functions can write
    match /payments/{paymentId} {
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if false;  // Only Cloud Functions can write
    }

    // Course enrollments - students can read their own, only Cloud Functions can write
    match /course_enrollments/{enrollmentId} {
      allow read: if isAuthenticated() &&
        (resource.data.studentId == request.auth.uid || isAdmin());
      allow write: if false;  // Only Cloud Functions can write
    }

    // ============================================
    // EXISTING COLLECTIONS (GENERAL ACCESS)
    // ============================================

    // Users - can read own profile, admins can write
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if request.auth.uid == userId || isAdmin();
    }

    // Courses - authenticated users can read, teachers/admins can write
    match /courses/{courseId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Content - authenticated users can read, teachers/admins can write
    match /content/{contentId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Exercises - authenticated users can read, teachers/admins can write
    match /exercises/{exerciseId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // ============================================
    // UNIFIED CONTENT SYSTEM (NEW)
    // ============================================

    // Contents - unified collection for all content types
    // (courses, lessons, readings, videos, links, exercises, live-games)
    match /contents/{contentId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Content-Course relationships
    match /content_courses/{relationshipId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Groups - authenticated users can read, teachers/admins can write
    match /groups/{groupId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Group members - authenticated users can read, teachers/admins can write
    match /group_members/{memberId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Group courses - authenticated users can read, teachers/admins can write
    match /group_courses/{groupCourseId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Assignments - students can read assigned to them, teachers can read/write their own
    match /assignments/{assignmentId} {
      allow read: if isAuthenticated() &&
        (resource.data.assignedTo.hasAny([request.auth.uid]) ||
         resource.data.createdBy == request.auth.uid ||
         isAdmin());
      allow write: if isTeacher() || isAdmin();
    }

    // Assignment submissions - students can read/write their own, teachers can read
    match /assignment_submissions/{submissionId} {
      allow read: if isAuthenticated() &&
        (resource.data.studentId == request.auth.uid ||
         isTeacher() ||
         isAdmin());
      allow write: if isAuthenticated() &&
        (resource.data.studentId == request.auth.uid || isAdmin());
    }

    // Messages - users can read/write their own conversations
    match /messages/{messageId} {
      allow read: if isAuthenticated() &&
        (resource.data.senderId == request.auth.uid ||
         resource.data.recipientId == request.auth.uid ||
         isAdmin());
      allow write: if isAuthenticated() &&
        (resource.data.senderId == request.auth.uid || isAdmin());
    }

    // Conversations - users can read their own conversations
    match /conversations/{conversationId} {
      allow read: if isAuthenticated() &&
        (resource.data.participants.hasAny([request.auth.uid]) || isAdmin());
      allow write: if isAuthenticated() &&
        (resource.data.participants.hasAny([request.auth.uid]) || isAdmin());
    }

    // Guardian links - guardians and students can read their own links
    match /guardian_links/{linkId} {
      allow read: if isAuthenticated() &&
        (resource.data.guardianId == request.auth.uid ||
         resource.data.studentId == request.auth.uid ||
         isAdmin());
      allow write: if isAdmin() ||
        (isAuthenticated() && resource.data.guardianId == request.auth.uid);
    }

    // Gamification data - students can read/write their own, admins can read all
    match /user_gamification/{userId} {
      allow read: if isAuthenticated() &&
        (request.auth.uid == userId || isAdmin());
      allow write: if request.auth.uid == userId || isAdmin();
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
