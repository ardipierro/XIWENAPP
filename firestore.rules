rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Check if user is admin
    function isAdmin() {
      return request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Check if user is teacher
    function isTeacher() {
      return request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // ============================================
    // PAYMENT SYSTEM COLLECTIONS
    // ============================================

    // Student enrollments - admins can read/write all, students/guardians can read their own
    match /student_enrollments/{enrollmentId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Monthly fees - students can read their own, only Cloud Functions can write
    match /monthly_fees/{feeId} {
      allow read: if isAuthenticated() &&
        (resource.data.studentId == request.auth.uid || isAdmin());
      allow write: if false;  // Only Cloud Functions can write
    }

    // Scholarships - students can read their own, admins can write
    match /scholarships/{scholarshipId} {
      allow read: if isAuthenticated() &&
        (resource.data.studentId == request.auth.uid || isAdmin());
      allow write: if isAdmin();
    }

    // Family groups - guardians can read their own, admins can write
    match /family_groups/{groupId} {
      allow read: if isAuthenticated() &&
        (resource.data.guardianId == request.auth.uid || isAdmin());
      allow write: if isAdmin();
    }

    // Payments - users can read their own, only Cloud Functions can write
    match /payments/{paymentId} {
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if false;  // Only Cloud Functions can write
    }

    // Course enrollments - students can read their own, admins can read all
    match /course_enrollments/{enrollmentId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();  // Admins can write for testing/management
    }

    // User credits - users can read/write their own, admins can manage all
    match /user_credits/{creditId} {
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if isAuthenticated() &&
        (request.resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() &&
        (request.resource.data.userId == request.auth.uid || isAdmin());
    }

    // ============================================
    // EXISTING COLLECTIONS (GENERAL ACCESS)
    // ============================================

    // Users - can read own profile, admins can write
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if request.auth.uid == userId || isAdmin();

      // Exercise Builder configs subcollection
      match /configs/{configId} {
        allow read: if isAuthenticated() &&
          (request.auth.uid == userId || isAdmin());
        allow write: if isAuthenticated() &&
          (request.auth.uid == userId || isAdmin());
      }
    }

    // Courses - authenticated users can read, teachers/admins can write
    match /courses/{courseId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Content - authenticated users can read, teachers/admins can write
    match /content/{contentId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Content assignments - teachers can assign, students can read their own
    match /content_assignments/{assignmentId} {
      allow read: if isAuthenticated() &&
        (resource.data.studentId == request.auth.uid || isTeacher() || isAdmin());
      allow create, update: if isTeacher() || isAdmin();
      allow delete: if isAdmin();
    }

    // Exercises - authenticated users can read, teachers/admins can write
    match /exercises/{exerciseId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // ============================================
    // UNIFIED CONTENT SYSTEM (NEW)
    // ============================================

    // Contents - unified collection for all content types
    // (courses, lessons, readings, videos, links, exercises, live-games)
    match /contents/{contentId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Content-Course relationships
    match /content_courses/{relationshipId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Groups - authenticated users can read, teachers/admins can write
    match /groups/{groupId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Group members - authenticated users can read, teachers/admins can write
    match /group_members/{memberId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Group courses - authenticated users can read, teachers/admins can write
    match /group_courses/{groupCourseId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Assignments - students can read from enrolled courses, teachers can read/write their own
    match /assignments/{assignmentId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Assignment submissions - students can read/write their own, teachers can read
    match /assignment_submissions/{submissionId} {
      allow read: if isAuthenticated() &&
        (resource.data.studentId == request.auth.uid ||
         isTeacher() ||
         isAdmin());
      allow write: if isAuthenticated() &&
        (resource.data.studentId == request.auth.uid || isAdmin());
    }

    // Messages - users can read/write their own conversations
    match /messages/{messageId} {
      allow read: if isAuthenticated() &&
        (resource.data.senderId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() &&
        request.resource.data.senderId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
        (resource.data.senderId == request.auth.uid || isAdmin());
    }

    // Conversations - users can read their own conversations
    match /conversations/{conversationId} {
      allow read: if isAuthenticated() &&
        (resource.data.participants.hasAny([request.auth.uid]) || isAdmin());
      allow create: if isAuthenticated() &&
        request.resource.data.participants.hasAny([request.auth.uid]);
      allow update: if isAuthenticated() &&
        (resource.data.participants.hasAny([request.auth.uid]) || isAdmin());
      allow delete: if isAdmin();
    }

    // Guardian links - guardians and students can read their own links
    match /guardian_links/{linkId} {
      allow read: if isAuthenticated() &&
        (resource.data.guardianId == request.auth.uid ||
         resource.data.studentId == request.auth.uid ||
         isAdmin());
      allow write: if isAdmin() ||
        (isAuthenticated() && resource.data.guardianId == request.auth.uid);
    }

    // Gamification data - students can read/write their own, admins can read all
    match /user_gamification/{userId} {
      allow read: if isAuthenticated() &&
        (request.auth.uid == userId || isAdmin());
      allow write: if request.auth.uid == userId || isAdmin();
    }

    // ============================================
    // CLASS MANAGEMENT COLLECTIONS
    // ============================================

    // Classes - recurring class schedules
    match /classes/{classId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Recurring schedules - recurring class schedules
    match /recurring_schedules/{scheduleId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Class instances - specific occurrences of classes
    match /class_instances/{instanceId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Class sessions - live class sessions
    match /class_sessions/{sessionId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Class attendance - attendance records
    match /class_attendance/{attendanceId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Calendar events
    match /calendarEvents/{eventId} {
      allow read: if isAuthenticated() &&
        (resource.data.participants.hasAny([request.auth.uid]) ||
         resource.data.createdBy == request.auth.uid ||
         isAdmin() ||
         isTeacher());
      allow write: if isTeacher() || isAdmin();
    }

    // Scheduled classes
    match /scheduledClasses/{classId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // ============================================
    // STUDENT & ENROLLMENT COLLECTIONS
    // ============================================

    // Students collection (separate from users)
    match /students/{studentId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Enrollments - course enrollments
    match /enrollments/{enrollmentId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Submissions - assignment submissions
    match /submissions/{submissionId} {
      allow read: if isAuthenticated() &&
        (resource.data.studentId == request.auth.uid ||
         isTeacher() ||
         isAdmin());
      allow write: if isAuthenticated() &&
        (resource.data.studentId == request.auth.uid || isAdmin());
    }

    // ============================================
    // GAME & ANALYTICS COLLECTIONS
    // ============================================

    // Game history
    match /game_history/{gameId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Game history (alternative collection name)
    match /gameHistory/{gameId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Categories - single document with all categories data
    match /categories/{categoryId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // ============================================
    // CREDIT SYSTEM COLLECTIONS
    // ============================================

    // Credit transactions
    match /credit_transactions/{transactionId} {
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if isAdmin();
    }

    // ============================================
    // LIVE CLASS COLLECTIONS
    // ============================================

    // Live classes
    match /live_classes/{classId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Live class participants
    match /live_class_participants/{participantId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ============================================
    // WHITEBOARD COLLECTIONS
    // ============================================

    // Whiteboard sessions
    match /whiteboard_sessions/{sessionId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Excalidraw sessions
    match /excalidraw_sessions/{sessionId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // ============================================
    // AI CONFIGURATION
    // ============================================

    // AI configuration - only admins can read/write
    match /ai_config/{configId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // ============================================
    // CONTENT READER ANNOTATIONS
    // ============================================

    // Annotations - users can read/write their own annotations
    match /annotations/{annotationId} {
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if isAuthenticated() &&
        (request.resource.data.userId == request.auth.uid || isAdmin());
    }

    // ============================================
    // HOMEWORK REVIEW SYSTEM
    // ============================================

    // Homework reviews - AI-analyzed homework submissions
    match /homework_reviews/{reviewId} {
      // Students can create reviews for their own homework
      // Teachers and admins can create reviews for any student (manual upload)
      allow create: if isAuthenticated() &&
        (request.resource.data.studentId == request.auth.uid ||
         isTeacher() ||
         isAdmin());

      // Students can read their own reviews (only teacher-approved ones for assignments)
      // Teachers and admins can read all reviews
      allow read: if isAuthenticated() &&
        (resource.data.studentId == request.auth.uid ||
         isTeacher() ||
         isAdmin());

      // Only teachers and admins can update reviews (for approval)
      allow update: if isTeacher() || isAdmin();

      // Only admins can delete reviews
      allow delete: if isAdmin();
    }

    // ============================================
    // HOMEWORK CORRECTION PROFILES
    // ============================================

    // Correction profiles - Configuration for how to correct homework
    match /correction_profiles/{profileId} {
      // Teachers can create profiles with their own teacherId, admins can create for anyone
      allow create: if isAuthenticated() &&
        (isAdmin() ||
         (isTeacher() && request.resource.data.teacherId == request.auth.uid));

      // Admins can list/read all profiles, teachers can read their own
      allow list, get: if isAuthenticated() &&
        (isAdmin() ||
         resource.data.teacherId == request.auth.uid);

      // Teachers can update their own profiles, admins can update all
      allow update: if isAuthenticated() &&
        (isAdmin() ||
         resource.data.teacherId == request.auth.uid);

      // Teachers can delete their own profiles, admins can delete all
      allow delete: if isAuthenticated() &&
        (isAdmin() ||
         resource.data.teacherId == request.auth.uid);
    }

    // Profile-student assignments - Assign profiles to individual students
    match /profile_students/{assignmentId} {
      // Teachers can create assignments for their students
      allow create: if isAuthenticated() &&
        (isTeacher() || isAdmin());

      // Teachers can read assignments, students can read their own
      allow read: if isAuthenticated() &&
        (resource.data.studentId == request.auth.uid ||
         isTeacher() ||
         isAdmin());

      // Teachers and admins can update assignments
      allow update: if isTeacher() || isAdmin();

      // Teachers and admins can delete assignments
      allow delete: if isTeacher() || isAdmin();
    }

    // Profile-group assignments - Assign profiles to groups
    match /profile_groups/{assignmentId} {
      // Teachers can create assignments for their groups
      allow create: if isAuthenticated() &&
        (isTeacher() || isAdmin());

      // Teachers and admins can read assignments
      allow read: if isTeacher() || isAdmin();

      // Teachers and admins can update assignments
      allow update: if isTeacher() || isAdmin();

      // Teachers and admins can delete assignments
      allow delete: if isTeacher() || isAdmin();
    }

    // ============================================
    // VOICE PRESETS (ELEVENLABS)
    // ============================================

    // Voice presets - ElevenLabs voice configurations
    match /voicePresets/{presetId} {
      // Teachers can create presets with their own teacherId, admins can create for anyone
      allow create: if isAuthenticated() &&
        (isAdmin() ||
         (isTeacher() && request.resource.data.teacherId == request.auth.uid));

      // Admins can list/read all presets, teachers can read their own
      allow list, get: if isAuthenticated() &&
        (isAdmin() ||
         resource.data.teacherId == request.auth.uid);

      // Teachers can update their own presets, admins can update all
      allow update: if isAuthenticated() &&
        (isAdmin() ||
         resource.data.teacherId == request.auth.uid);

      // Teachers can delete their own presets, admins can delete all
      allow delete: if isAuthenticated() &&
        (isAdmin() ||
         resource.data.teacherId == request.auth.uid);
    }

    // ============================================
    // LANDING PAGE CONFIGURATION
    // ============================================

    // Landing page configuration - anyone can read (public landing), only admins can write
    match /landing_config/{configId} {
      allow read: if true;  // Public read access for landing page
      allow write: if isAdmin();
    }

    // Landing page configuration history - only admins can read/write
    match /landing_config_history/{versionId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // ============================================
    // FLASHCARD COLLECTIONS
    // ============================================

    // Flashcard collections - authenticated users can read, teachers/admins can write
    match /flashcard_collections/{collectionId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();

      // Flashcards subcollection
      match /flashcards/{cardId} {
        allow read: if isAuthenticated();
        allow write: if isTeacher() || isAdmin();
      }
    }

    // Flashcard study sessions - users can read/write their own sessions
    match /flashcard_sessions/{sessionId} {
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if isAuthenticated() &&
        (request.resource.data.userId == request.auth.uid || isAdmin());
    }

    // Flashcard progress - users can read/write their own progress
    match /flashcard_progress/{progressId} {
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if isAuthenticated() &&
        (request.resource.data.userId == request.auth.uid || isAdmin());
    }

    // ============================================
    // CLASS DAILY LOGS
    // ============================================

    // Class daily logs - Daily feed/timeline of class content
    match /class_daily_logs/{logId} {
      // Teachers can create logs with their own teacherId, admins can create for anyone
      allow create: if isAuthenticated() &&
        (isAdmin() ||
         (isTeacher() && request.resource.data.teacherId == request.auth.uid));

      // Teachers can read their own logs, students can read logs they're assigned to, admins can read all
      allow read: if isAuthenticated() &&
        (isAdmin() ||
         resource.data.teacherId == request.auth.uid ||
         resource.data.assignedStudents.hasAny([request.auth.uid]));

      // Teachers can update their own logs, admins can update all
      allow update: if isAuthenticated() &&
        (isAdmin() ||
         resource.data.teacherId == request.auth.uid);

      // Teachers can delete their own logs, admins can delete all
      allow delete: if isAuthenticated() &&
        (isAdmin() ||
         resource.data.teacherId == request.auth.uid);
    }

    // ============================================
    // NOTIFICATIONS
    // ============================================

    // Notifications - users can read their own, admins can read/write all
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && isAdmin();
      allow update, delete: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ============================================
    // SYSTEM CONFIGURATION
    // ============================================

    // System configuration - all users can read, only admins can write
    match /system/{document} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
