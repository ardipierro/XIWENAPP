<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Restaurar Credenciales de IA - XIWEN App</title>
  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --success: #22c55e;
      --warning: #eab308;
      --danger: #ef4444;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 2rem;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.75rem;
      margin-bottom: 0.5rem;
      color: var(--text);
    }

    .subtitle {
      color: var(--text-muted);
      margin-bottom: 2rem;
    }

    .warning-box {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    .warning-box h3 {
      color: #92400e;
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
    }

    .warning-box p {
      color: #a16207;
      font-size: 0.875rem;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .card h2 {
      font-size: 1.1rem;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
      color: var(--text);
    }

    .label-hint {
      font-weight: normal;
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 0.625rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.875rem;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .providers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
    }

    .provider-card {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      background: #fafafa;
    }

    .provider-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .provider-emoji {
      font-size: 1.25rem;
    }

    .provider-name {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .provider-desc {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .provider-link {
      font-size: 0.75rem;
      color: var(--primary);
      text-decoration: none;
      margin-top: 0.5rem;
      display: inline-block;
    }

    .provider-link:hover {
      text-decoration: underline;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .status-configured {
      background: #dcfce7;
      color: #166534;
    }

    .status-empty {
      background: #f3f4f6;
      color: #6b7280;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      border: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-primary:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #16a34a;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-outline:hover {
      background: #f1f5f9;
    }

    .actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .log-area {
      background: #1e293b;
      color: #e2e8f0;
      border-radius: 8px;
      padding: 1rem;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.8rem;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 1rem;
    }

    .log-entry {
      margin-bottom: 0.25rem;
    }

    .log-success { color: #4ade80; }
    .log-error { color: #f87171; }
    .log-info { color: #60a5fa; }
    .log-warning { color: #fbbf24; }

    .hidden { display: none; }

    #step2, #step3 { display: none; }

    .step-indicator {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: #f1f5f9;
      border-radius: 6px;
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .step.active {
      background: var(--primary);
      color: white;
    }

    .step.completed {
      background: var(--success);
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Restaurar Credenciales de IA</h1>
    <p class="subtitle">Herramienta para restaurar las credenciales de proveedores de IA en Firestore</p>

    <div class="step-indicator">
      <div class="step active" id="step1-indicator">1. Configurar Firebase</div>
      <div class="step" id="step2-indicator">2. Autenticarse</div>
      <div class="step" id="step3-indicator">3. Restaurar Credenciales</div>
    </div>

    <!-- Step 1: Firebase Config -->
    <div id="step1">
      <div class="card">
        <h2>Paso 1: Configuracion de Firebase</h2>

        <div class="warning-box">
          <h3>Importante</h3>
          <p>Ingresa los datos de tu proyecto Firebase. Los encontraras en la consola de Firebase o en tu archivo .env</p>
        </div>

        <div class="form-group">
          <label>API Key <span class="label-hint">(VITE_FIREBASE_API_KEY)</span></label>
          <input type="text" id="apiKey" placeholder="AIzaSy...">
        </div>

        <div class="form-group">
          <label>Auth Domain <span class="label-hint">(VITE_FIREBASE_AUTH_DOMAIN)</span></label>
          <input type="text" id="authDomain" placeholder="proyecto.firebaseapp.com">
        </div>

        <div class="form-group">
          <label>Project ID <span class="label-hint">(VITE_FIREBASE_PROJECT_ID)</span></label>
          <input type="text" id="projectId" placeholder="xiwen-app-2026">
        </div>

        <div class="form-group">
          <label>Storage Bucket <span class="label-hint">(VITE_FIREBASE_STORAGE_BUCKET)</span></label>
          <input type="text" id="storageBucket" placeholder="proyecto.appspot.com">
        </div>

        <div class="form-group">
          <label>Messaging Sender ID <span class="label-hint">(VITE_FIREBASE_MESSAGING_SENDER_ID)</span></label>
          <input type="text" id="messagingSenderId" placeholder="123456789">
        </div>

        <div class="form-group">
          <label>App ID <span class="label-hint">(VITE_FIREBASE_APP_ID)</span></label>
          <input type="text" id="appId" placeholder="1:123456789:web:abc123">
        </div>

        <div class="actions">
          <button class="btn btn-primary" onclick="initializeFirebase()">Conectar a Firebase</button>
        </div>
      </div>
    </div>

    <!-- Step 2: Authentication -->
    <div id="step2">
      <div class="card">
        <h2>Paso 2: Autenticacion como Admin</h2>

        <div class="warning-box">
          <h3>Acceso Requerido</h3>
          <p>Debes autenticarte con una cuenta de administrador para poder escribir en la coleccion ai_credentials.</p>
        </div>

        <div class="form-group">
          <label>Email del Admin</label>
          <input type="text" id="adminEmail" placeholder="admin@ejemplo.com">
        </div>

        <div class="form-group">
          <label>Contrasena</label>
          <input type="password" id="adminPassword" placeholder="Tu contrasena">
        </div>

        <div class="actions">
          <button class="btn btn-outline" onclick="goToStep(1)">Atras</button>
          <button class="btn btn-primary" onclick="authenticate()">Iniciar Sesion</button>
        </div>
      </div>
    </div>

    <!-- Step 3: Credentials -->
    <div id="step3">
      <div class="card">
        <h2>Paso 3: Ingresa las API Keys</h2>

        <p style="margin-bottom: 1rem; color: var(--text-muted); font-size: 0.875rem;">
          Ingresa las API keys de los proveedores que tengas configurados. Solo se guardaran las que tengan valor.
        </p>

        <div class="providers-grid">
          <!-- OpenAI -->
          <div class="provider-card">
            <div class="provider-header">
              <span class="provider-emoji">ü§ñ</span>
              <div>
                <div class="provider-name">OpenAI</div>
                <div class="provider-desc">GPT-4, DALL-E 3, Whisper</div>
              </div>
            </div>
            <input type="password" id="cred_openai" placeholder="sk-...">
            <a href="https://platform.openai.com/api-keys" target="_blank" class="provider-link">Obtener API Key</a>
          </div>

          <!-- Anthropic -->
          <div class="provider-card">
            <div class="provider-header">
              <span class="provider-emoji">üß†</span>
              <div>
                <div class="provider-name">Anthropic (Claude)</div>
                <div class="provider-desc">Claude 3 Opus, Sonnet, Haiku</div>
              </div>
            </div>
            <input type="password" id="cred_anthropic" placeholder="sk-ant-...">
            <a href="https://console.anthropic.com/settings/keys" target="_blank" class="provider-link">Obtener API Key</a>
          </div>

          <!-- Google -->
          <div class="provider-card">
            <div class="provider-header">
              <span class="provider-emoji">üîç</span>
              <div>
                <div class="provider-name">Google Cloud (Gemini)</div>
                <div class="provider-desc">Gemini Pro, Cloud TTS</div>
              </div>
            </div>
            <input type="password" id="cred_google" placeholder="AIzaSy...">
            <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="provider-link">Obtener API Key</a>
          </div>

          <!-- Google Translate -->
          <div class="provider-card">
            <div class="provider-header">
              <span class="provider-emoji">üåê</span>
              <div>
                <div class="provider-name">Google Translate API</div>
                <div class="provider-desc">Traduccion espanol-chino</div>
              </div>
            </div>
            <input type="password" id="cred_google_translate" placeholder="AIzaSy...">
            <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="provider-link">Obtener API Key</a>
          </div>

          <!-- Grok -->
          <div class="provider-card">
            <div class="provider-header">
              <span class="provider-emoji">X</span>
              <div>
                <div class="provider-name">xAI (Grok)</div>
                <div class="provider-desc">Grok - Conversational AI</div>
              </div>
            </div>
            <input type="password" id="cred_grok" placeholder="xai-...">
            <a href="https://console.x.ai/" target="_blank" class="provider-link">Obtener API Key</a>
          </div>

          <!-- ElevenLabs -->
          <div class="provider-card">
            <div class="provider-header">
              <span class="provider-emoji">üéôÔ∏è</span>
              <div>
                <div class="provider-name">ElevenLabs</div>
                <div class="provider-desc">Text-to-Speech premium</div>
              </div>
            </div>
            <input type="password" id="cred_elevenlabs" placeholder="sk_...">
            <a href="https://elevenlabs.io/app/settings/api-keys" target="_blank" class="provider-link">Obtener API Key</a>
          </div>

          <!-- Stability -->
          <div class="provider-card">
            <div class="provider-header">
              <span class="provider-emoji">üé®</span>
              <div>
                <div class="provider-name">Stability AI</div>
                <div class="provider-desc">Stable Diffusion, ilustraciones</div>
              </div>
            </div>
            <input type="password" id="cred_stability" placeholder="sk-...">
            <a href="https://platform.stability.ai/account/keys" target="_blank" class="provider-link">Obtener API Key</a>
          </div>

          <!-- Replicate -->
          <div class="provider-card">
            <div class="provider-header">
              <span class="provider-emoji">üîÆ</span>
              <div>
                <div class="provider-name">Replicate</div>
                <div class="provider-desc">Flux, SDXL, multiple models</div>
              </div>
            </div>
            <input type="password" id="cred_replicate" placeholder="r8_...">
            <a href="https://replicate.com/account/api-tokens" target="_blank" class="provider-link">Obtener API Key</a>
          </div>

          <!-- Leonardo -->
          <div class="provider-card">
            <div class="provider-header">
              <span class="provider-emoji">üñºÔ∏è</span>
              <div>
                <div class="provider-name">Leonardo.ai</div>
                <div class="provider-desc">Image and art generation</div>
              </div>
            </div>
            <input type="password" id="cred_leonardo" placeholder="...">
            <a href="https://app.leonardo.ai/settings" target="_blank" class="provider-link">Obtener API Key</a>
          </div>

          <!-- HuggingFace -->
          <div class="provider-card">
            <div class="provider-header">
              <span class="provider-emoji">ü§ó</span>
              <div>
                <div class="provider-name">Hugging Face</div>
                <div class="provider-desc">Open source AI models</div>
              </div>
            </div>
            <input type="password" id="cred_huggingface" placeholder="hf_...">
            <a href="https://huggingface.co/settings/tokens" target="_blank" class="provider-link">Obtener API Key</a>
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-outline" onclick="goToStep(2)">Atras</button>
          <button class="btn btn-success" onclick="saveAllCredentials()">Guardar Todas las Credenciales</button>
        </div>
      </div>

      <!-- Log Area -->
      <div class="card">
        <h2>Registro de Operaciones</h2>
        <div class="log-area" id="logArea">
          <div class="log-entry log-info">Esperando operacion...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { getFirestore, doc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
    import { getAuth, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';

    let app = null;
    let db = null;
    let auth = null;
    let currentUser = null;

    // Make functions available globally
    window.initializeFirebase = async function() {
      try {
        const config = {
          apiKey: document.getElementById('apiKey').value.trim(),
          authDomain: document.getElementById('authDomain').value.trim(),
          projectId: document.getElementById('projectId').value.trim(),
          storageBucket: document.getElementById('storageBucket').value.trim(),
          messagingSenderId: document.getElementById('messagingSenderId').value.trim(),
          appId: document.getElementById('appId').value.trim()
        };

        // Validate
        if (!config.apiKey || !config.projectId) {
          alert('Por favor ingresa al menos API Key y Project ID');
          return;
        }

        app = initializeApp(config);
        db = getFirestore(app);
        auth = getAuth(app);

        log('Firebase inicializado correctamente', 'success');
        log(`Proyecto: ${config.projectId}`, 'info');

        goToStep(2);
      } catch (error) {
        log(`Error al inicializar Firebase: ${error.message}`, 'error');
        alert('Error al conectar con Firebase: ' + error.message);
      }
    };

    window.authenticate = async function() {
      try {
        const email = document.getElementById('adminEmail').value.trim();
        const password = document.getElementById('adminPassword').value;

        if (!email || !password) {
          alert('Por favor ingresa email y contrasena');
          return;
        }

        log('Autenticando...', 'info');

        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        currentUser = userCredential.user;

        log(`Autenticado como: ${currentUser.email}`, 'success');

        goToStep(3);
      } catch (error) {
        log(`Error de autenticacion: ${error.message}`, 'error');
        alert('Error al autenticar: ' + error.message);
      }
    };

    window.saveAllCredentials = async function() {
      if (!db || !currentUser) {
        alert('Debes estar autenticado primero');
        return;
      }

      const providers = [
        'openai',
        'anthropic',
        'google',
        'google_translate',
        'grok',
        'elevenlabs',
        'stability',
        'replicate',
        'leonardo',
        'huggingface'
      ];

      log('='.repeat(50), 'info');
      log('Iniciando restauracion de credenciales...', 'info');

      let saved = 0;
      let skipped = 0;
      let errors = 0;

      for (const providerId of providers) {
        const input = document.getElementById(`cred_${providerId}`);
        const apiKey = input ? input.value.trim() : '';

        if (!apiKey) {
          log(`[${providerId}] Sin valor - omitido`, 'warning');
          skipped++;
          continue;
        }

        try {
          const docRef = doc(db, 'ai_credentials', providerId);
          await setDoc(docRef, {
            apiKey: apiKey,
            updatedAt: serverTimestamp(),
            source: 'user',
            isCustom: false,
            restoredAt: new Date().toISOString(),
            restoredBy: currentUser.email
          });

          log(`[${providerId}] Guardado correctamente`, 'success');
          saved++;

          // Clear input for security
          input.value = '';

        } catch (error) {
          log(`[${providerId}] Error: ${error.message}`, 'error');
          errors++;
        }
      }

      log('='.repeat(50), 'info');
      log(`Restauracion completada:`, 'info');
      log(`  - Guardados: ${saved}`, 'success');
      log(`  - Omitidos: ${skipped}`, 'warning');
      log(`  - Errores: ${errors}`, errors > 0 ? 'error' : 'info');

      if (saved > 0 && errors === 0) {
        alert(`Exito! Se restauraron ${saved} credenciales correctamente.\n\nAhora puedes cerrar esta pagina y recargar la aplicacion XIWEN.`);
      } else if (saved > 0) {
        alert(`Se restauraron ${saved} credenciales, pero hubo ${errors} errores. Revisa el registro.`);
      }
    };

    window.goToStep = function(step) {
      // Hide all steps
      document.getElementById('step1').style.display = 'none';
      document.getElementById('step2').style.display = 'none';
      document.getElementById('step3').style.display = 'none';

      // Update indicators
      document.getElementById('step1-indicator').className = 'step';
      document.getElementById('step2-indicator').className = 'step';
      document.getElementById('step3-indicator').className = 'step';

      // Show current step
      document.getElementById(`step${step}`).style.display = 'block';
      document.getElementById(`step${step}-indicator`).className = 'step active';

      // Mark completed steps
      for (let i = 1; i < step; i++) {
        document.getElementById(`step${i}-indicator`).className = 'step completed';
      }
    };

    function log(message, type = 'info') {
      const logArea = document.getElementById('logArea');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      const time = new Date().toLocaleTimeString();
      entry.textContent = `[${time}] ${message}`;
      logArea.appendChild(entry);
      logArea.scrollTop = logArea.scrollHeight;
    }

    // Initialize
    window.log = log;
  </script>
</body>
</html>
