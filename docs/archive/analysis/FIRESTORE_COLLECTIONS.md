# üóÑÔ∏è Firestore Collections - Payment System

Complete documentation of all Firestore collections for the student payment system.

---

## üìö Collections Overview

| Collection | Purpose | Auto-generated |
|------------|---------|----------------|
| `student_enrollments` | Student enrollment records | Manual |
| `monthly_fees` | Monthly fee records | Cron job |
| `scholarships` | Student scholarships/becas | Manual |
| `family_groups` | Family discount groups | Manual |
| `payments` | All payment records | Webhook |
| `course_enrollments` | Course access records | Webhook |

---

## 1. student_enrollments

Stores student enrollment information and payment configuration.

### Document ID
Auto-generated by Firestore

### Fields

```javascript
{
  // Student info
  studentId: string,              // User ID (required)
  studentName: string,            // Full name (required)
  studentEmail: string,           // Email (required)
  guardianId?: string,            // Parent/tutor ID (optional)

  // Enrollment details
  enrollmentType: string,         // 'annual' | 'monthly' | 'course'
  academicYear: string,           // "2025", "2026", etc.
  grade?: string,                 // "5to grado", "Secundaria", etc.

  // Pricing
  matriculaAmount: number,        // Enrollment fee (ARS)
  cuotaAmount: number,            // Monthly fee (ARS)
  discount: number,               // Discount percentage (0-100)
  discountReason: string,         // "Segundo hermano", "Beca 50%", etc.

  // Status
  status: string,                 // 'pending' | 'active' | 'suspended' | 'graduated'

  // Matr√≠cula payment
  matriculaPaid: boolean,         // Has paid enrollment fee
  matriculaPaymentId?: string,    // MercadoPago payment ID
  matriculaPaidAt?: Timestamp,    // Payment date

  // Dates
  enrolledAt: Timestamp,          // Enrollment date (required)
  expiresAt?: Timestamp,          // Expiration date (optional)
  createdAt: Timestamp,           // Created timestamp
  updatedAt?: Timestamp           // Last updated
}
```

### Example

```javascript
{
  studentId: "user123",
  studentName: "Juan P√©rez",
  studentEmail: "juan@example.com",
  guardianId: "guardian456",
  enrollmentType: "annual",
  academicYear: "2025",
  grade: "5to grado",
  matriculaAmount: 15000,
  cuotaAmount: 8000,
  discount: 20,
  discountReason: "Segundo hermano - 20% descuento",
  status: "active",
  matriculaPaid: true,
  matriculaPaymentId: "123456789",
  matriculaPaidAt: Timestamp.now(),
  enrolledAt: Timestamp.now(),
  expiresAt: Timestamp.fromDate(new Date('2025-12-31')),
  createdAt: Timestamp.now()
}
```

### Indexes Required

```
- studentId (ascending)
- status (ascending) + createdAt (descending)
- guardianId (ascending)
```

---

## 2. monthly_fees

Auto-generated monthly fee records for all active students.

**‚ö†Ô∏è Generated automatically by `generateMonthlyFees` cron job on the 1st of each month**

### Document ID
Auto-generated by Firestore

### Fields

```javascript
{
  // Student info
  studentId: string,              // User ID (required)
  studentName: string,            // Full name (required)
  studentEmail: string,           // Email (required)
  enrollmentId: string,           // Reference to enrollment (required)

  // Fee period
  month: string,                  // "2025-03" format (required)
  monthName: string,              // "Marzo 2025" (required)

  // Amounts
  amount: number,                 // Base amount (ARS)
  discount: number,               // Discount amount (ARS)
  discountPercentage: number,     // Discount % (0-100)
  finalAmount: number,            // Amount after discount (required)

  // Status
  status: string,                 // 'pending' | 'paid' | 'overdue' | 'forgiven'

  // Payment info
  paymentId?: string,             // Payment document ID
  mercadopagoPaymentId?: string,  // MercadoPago payment ID
  paidAt?: Timestamp,             // Payment date

  // Due date
  dueDate: Timestamp,             // Due date (usually 10th of month) (required)

  // Late fees (calculated by checkOverdueFees cron)
  lateFee: number,                // Late fee amount (ARS)
  daysPastDue: number,            // Days past due

  // Timestamps
  createdAt: Timestamp,           // Created timestamp (required)
  updatedAt?: Timestamp           // Last updated
}
```

### Example

```javascript
{
  studentId: "user123",
  studentName: "Juan P√©rez",
  studentEmail: "juan@example.com",
  enrollmentId: "enrollment789",
  month: "2025-03",
  monthName: "Marzo 2025",
  amount: 8000,
  discount: 1600,
  discountPercentage: 20,
  finalAmount: 6400,
  status: "paid",
  paymentId: "payment001",
  mercadopagoPaymentId: "987654321",
  paidAt: Timestamp.now(),
  dueDate: Timestamp.fromDate(new Date('2025-03-10')),
  lateFee: 0,
  daysPastDue: 0,
  createdAt: Timestamp.now()
}
```

### Indexes Required

```
- studentId (ascending) + month (ascending)
- status (ascending) + dueDate (ascending)
- enrollmentId (ascending)
```

---

## 3. scholarships

Student scholarship/beca records.

### Document ID
Auto-generated by Firestore

### Fields

```javascript
{
  // Student info
  studentId: string,              // User ID (required)
  studentName: string,            // Full name (required)

  // Scholarship details
  type: string,                   // 'full' | 'partial' (required)
  percentage: number,             // 0-100 (required)
  reason: string,                 // Reason for scholarship (required)

  // Coverage
  coversMatricula: boolean,       // Covers enrollment fee
  coversCuotas: boolean,          // Covers monthly fees
  coversCourses: boolean,         // Covers course purchases

  // Period
  startDate: Timestamp,           // Start date (required)
  endDate?: Timestamp,            // End date (null = indefinite)
  status: string,                 // 'active' | 'expired' | 'revoked'

  // Approval
  approvedBy: string,             // Admin user ID (required)
  approvedAt: Timestamp,          // Approval date (required)

  // Timestamps
  createdAt: Timestamp            // Created timestamp (required)
}
```

### Example

```javascript
{
  studentId: "user123",
  studentName: "Juan P√©rez",
  type: "partial",
  percentage: 50,
  reason: "M√©rito acad√©mico",
  coversMatricula: true,
  coversCuotas: true,
  coversCourses: false,
  startDate: Timestamp.fromDate(new Date('2025-01-01')),
  endDate: Timestamp.fromDate(new Date('2025-12-31')),
  status: "active",
  approvedBy: "admin123",
  approvedAt: Timestamp.now(),
  createdAt: Timestamp.now()
}
```

### Indexes Required

```
- studentId (ascending) + status (ascending)
- status (ascending) + endDate (ascending)
```

---

## 4. family_groups

Family discount groups for sibling discounts.

### Document ID
Auto-generated by Firestore

### Fields

```javascript
{
  // Guardian info
  guardianId: string,             // Guardian user ID (required)
  guardianName?: string,          // Guardian name

  // Students
  students: Array<{               // Array of students (required)
    studentId: string,            // Student user ID
    studentName: string,          // Student name
    order: number,                // Order (1 = first, 2 = second, etc.)
    discount: number              // Discount percentage
  }>,

  // Discount rules
  discountSecondChild: number,    // Discount for 2nd child (%)
  discountThirdChild: number,     // Discount for 3rd+ child (%)

  // Status
  active: boolean,                // Is group active (required)

  // Timestamps
  createdAt: Timestamp,           // Created timestamp (required)
  updatedAt?: Timestamp           // Last updated
}
```

### Example

```javascript
{
  guardianId: "guardian456",
  guardianName: "Mar√≠a L√≥pez",
  students: [
    {
      studentId: "student1",
      studentName: "Juan P√©rez",
      order: 1,
      discount: 0
    },
    {
      studentId: "student2",
      studentName: "Ana P√©rez",
      order: 2,
      discount: 20
    },
    {
      studentId: "student3",
      studentName: "Pedro P√©rez",
      order: 3,
      discount: 30
    }
  ],
  discountSecondChild: 20,
  discountThirdChild: 30,
  active: true,
  createdAt: Timestamp.now()
}
```

### Indexes Required

```
- guardianId (ascending)
- active (ascending)
```

---

## 5. payments

All payment records from MercadoPago webhook.

**‚ö†Ô∏è Created automatically by `mercadopagoWebhook` function**

### Document ID
Auto-generated by Firestore

### Fields

```javascript
{
  // User info
  userId: string,                 // Payer user ID (required)

  // Payment type
  type: string,                   // 'matricula' | 'monthly_fee' | 'course_purchase' (required)

  // Related documents
  enrollmentId?: string,          // For matricula
  feeId?: string,                 // For monthly_fee
  courseId?: string,              // For course_purchase

  // Amounts
  amount: number,                 // Amount (ARS) (required)
  currency: string,               // 'ARS' (required)

  // Status
  status: string,                 // 'approved' | 'pending' | 'rejected' | 'refunded' (required)

  // MercadoPago info
  mercadopagoPaymentId: string,   // MP payment ID (required)
  mercadopagoStatus: string,      // MP status (required)
  mercadopagoStatusDetail: string,// MP status detail (required)
  paymentMethod: string,          // 'credit_card' | 'debit_card' | etc. (required)

  // Payer info
  payerEmail: string,             // Payer email (required)
  payerName: string,              // Payer name (required)

  // Timestamps
  paidAt?: Timestamp,             // Payment date (if approved)
  createdAt: Timestamp            // Created timestamp (required)
}
```

### Example

```javascript
{
  userId: "user123",
  type: "monthly_fee",
  feeId: "fee456",
  amount: 6400,
  currency: "ARS",
  status: "approved",
  mercadopagoPaymentId: "987654321",
  mercadopagoStatus: "approved",
  mercadopagoStatusDetail: "accredited",
  paymentMethod: "credit_card",
  payerEmail: "juan@example.com",
  payerName: "Juan P√©rez",
  paidAt: Timestamp.now(),
  createdAt: Timestamp.now()
}
```

### Indexes Required

```
- userId (ascending) + createdAt (descending)
- mercadopagoPaymentId (ascending)
- type (ascending) + status (ascending)
```

---

## 6. course_enrollments

Course access records (for individual course purchases).

**‚ö†Ô∏è Created automatically by webhook when course is purchased**

### Document ID
Auto-generated by Firestore

### Fields

```javascript
{
  // Student info
  studentId: string,              // Student user ID (required)

  // Course info
  courseId: string,               // Course ID (required)

  // Payment
  paymentId: string,              // MercadoPago payment ID (required)

  // Status
  status: string,                 // 'active' | 'expired' | 'revoked'

  // Access
  expiresAt?: Timestamp,          // Expiration date (null = lifetime)

  // Timestamps
  enrolledAt: Timestamp           // Enrollment date (required)
}
```

### Example

```javascript
{
  studentId: "user123",
  courseId: "course789",
  paymentId: "987654321",
  status: "active",
  expiresAt: null,  // Lifetime access
  enrolledAt: Timestamp.now()
}
```

### Indexes Required

```
- studentId (ascending) + courseId (ascending)
- courseId (ascending) + status (ascending)
```

---

## üîê Firestore Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Student enrollments - students can read their own
    match /student_enrollments/{enrollmentId} {
      allow read: if request.auth != null &&
        (resource.data.studentId == request.auth.uid ||
         resource.data.guardianId == request.auth.uid);
      allow write: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Monthly fees - students can read their own
    match /monthly_fees/{feeId} {
      allow read: if request.auth != null &&
        resource.data.studentId == request.auth.uid;
      allow write: if false;  // Only Cloud Functions can write
    }

    // Scholarships - read only for students
    match /scholarships/{scholarshipId} {
      allow read: if request.auth != null &&
        resource.data.studentId == request.auth.uid;
      allow write: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Family groups - guardians can read their own
    match /family_groups/{groupId} {
      allow read: if request.auth != null &&
        resource.data.guardianId == request.auth.uid;
      allow write: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Payments - users can read their own
    match /payments/{paymentId} {
      allow read: if request.auth != null &&
        resource.data.userId == request.auth.uid;
      allow write: if false;  // Only Cloud Functions can write
    }

    // Course enrollments - students can read their own
    match /course_enrollments/{enrollmentId} {
      allow read: if request.auth != null &&
        resource.data.studentId == request.auth.uid;
      allow write: if false;  // Only Cloud Functions can write
    }
  }
}
```

---

## üìä Initial Data Setup

### Create sample enrollment (manual)

```javascript
// In Firestore console or via script
db.collection('student_enrollments').add({
  studentId: "USER_ID_HERE",
  studentName: "Juan P√©rez",
  studentEmail: "juan@example.com",
  enrollmentType: "annual",
  academicYear: "2025",
  grade: "5to grado",
  matriculaAmount: 15000,
  cuotaAmount: 8000,
  discount: 0,
  discountReason: "",
  status: "pending",  // Will be 'active' after matricula payment
  matriculaPaid: false,
  enrolledAt: admin.firestore.FieldValue.serverTimestamp(),
  expiresAt: admin.firestore.Timestamp.fromDate(new Date('2025-12-31')),
  createdAt: admin.firestore.FieldValue.serverTimestamp()
});
```

### Test cron jobs locally

```bash
# Generate monthly fees manually (for testing)
firebase functions:shell
> generateMonthlyFees()

# Check overdue fees manually (for testing)
> checkOverdueFees()
```

---

## üîç Useful Queries

### Get all pending fees for a student

```javascript
db.collection('monthly_fees')
  .where('studentId', '==', userId)
  .where('status', 'in', ['pending', 'overdue'])
  .orderBy('dueDate', 'asc')
  .get();
```

### Get all active scholarships

```javascript
db.collection('scholarships')
  .where('status', '==', 'active')
  .where('endDate', '>=', admin.firestore.Timestamp.now())
  .get();
```

### Get payment history for a student

```javascript
db.collection('payments')
  .where('userId', '==', userId)
  .orderBy('createdAt', 'desc')
  .limit(50)
  .get();
```

---

**Last updated:** 2025-11-07
**Version:** 1.0.0
